{
  "comments": [
    {
      "key": {
        "uuid": "9a6a9dd7_57e90c19",
        "filename": "opendaylight/md-sal/sal-akka-raft/src/main/java/org/opendaylight/controller/cluster/raft/behaviors/Follower.java",
        "patchSetId": 4
      },
      "lineNbr": 206,
      "author": {
        "id": 795
      },
      "writtenOn": "2015-06-03T04:40:21Z",
      "side": 1,
      "message": "Why are you explicitly setting commit index and last applied here? This should not be necessary. In fact if we have already applied an entry then setting last applied to an older entry would be just wrong.",
      "revId": "61afbe98f128e951c1fde7c06712b0660032c6aa",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a6a9dd7_da7b0128",
        "filename": "opendaylight/md-sal/sal-akka-raft/src/main/java/org/opendaylight/controller/cluster/raft/behaviors/Follower.java",
        "patchSetId": 4
      },
      "lineNbr": 206,
      "author": {
        "id": 1842
      },
      "writtenOn": "2015-06-03T11:34:45Z",
      "side": 1,
      "message": "We\u0027re reverting the log back so we need to revert the commit index as well although we should only do so if already \u003e\u003d removeFromIndex. If this isn\u0027t done then subsequent entries sent by the leader may not applied. I ran into this in a unit test. \n\nSay e.g., the follower\u0027s log has 5 entries and last commit is 4. Then it finds later that that index 0\u0027s term doesn\u0027t match the leader\u0027s term - the follower removes its stale index 0+ entry and then adds the index 0 entry from the leader and any subsequent entry. So if the follower\u0027s commit index was still 4 then the new index 0 up to index 3 don\u0027t get applied. That didn\u0027t seem right to me.",
      "parentUuid": "9a6a9dd7_57e90c19",
      "revId": "61afbe98f128e951c1fde7c06712b0660032c6aa",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a6a9dd7_cbed75f1",
        "filename": "opendaylight/md-sal/sal-akka-raft/src/main/java/org/opendaylight/controller/cluster/raft/behaviors/Follower.java",
        "patchSetId": 4
      },
      "lineNbr": 206,
      "author": {
        "id": 795
      },
      "writtenOn": "2015-06-03T18:25:37Z",
      "side": 1,
      "message": "The followers commit index is only supposed to move forward when the leader tells it to move the commit index forward. Once you say an entry is committed then it cannot be rolled back just because some leader came around and said so. First of all the new leader is not supposed to ask a follower to remove \"committed\" entries - that would be wrong as it would break the consensus algorithm.\n\nMaybe we have issues with our tests.",
      "parentUuid": "9a6a9dd7_da7b0128",
      "revId": "61afbe98f128e951c1fde7c06712b0660032c6aa",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a6a9dd7_cb725549",
        "filename": "opendaylight/md-sal/sal-akka-raft/src/main/java/org/opendaylight/controller/cluster/raft/behaviors/Follower.java",
        "patchSetId": 4
      },
      "lineNbr": 206,
      "author": {
        "id": 1842
      },
      "writtenOn": "2015-06-03T18:54:27Z",
      "side": 1,
      "message": "But the leader is the source of truth - the follower should match what the leader has. In my example above (and my test), the follower\u0027s journal matches the leader\u0027s but not the applied state. That seems wrong to me. So the follower could end up with lastApplied/lastCommitted at 10 but the last log index is 5. Replicates from the leader will not be applied until index 10 comes along. But meanwhile the follower has missed applying everything up to that point which will likely screw up the data tree. How can that be right?\n\nTake a look at the test (testHandleAppendEntriesReplyFailureWithFollowersLogTermDifferent). I don\u0027t think it\u0027s incorrect. The follower starts out with index 0, term 1 that was last committed and applied. The leader\u0027s log has indexes 0 and 1 but at term 2. The follower removes its term 1 entry and replaces it with the leader\u0027s 0 and 1 entries at term 2. I expected the new entries 0 and 1 to be applied. Index 1 was but index 0 wasn\u0027t. So the follower is basically throwing out it\u0027s previous log that had been previously committed so why wouldn\u0027t we roll back the commit index?",
      "parentUuid": "9a6a9dd7_cbed75f1",
      "revId": "61afbe98f128e951c1fde7c06712b0660032c6aa",
      "serverId": "7fc14799-209e-464c-9743-7a06c2c21a81",
      "unresolved": false
    }
  ]
}